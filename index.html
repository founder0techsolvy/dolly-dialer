<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dolly Dialer – Audio</title>
  <style>
    :root{--bg:#0f172a;--card:#111827;--text:#e5e7eb;--muted:#9ca3af;--pri:#22c55e;--pri2:#10b981;--warn:#f59e0b;--danger:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(135deg,#0f172a,#111827);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Noto Sans",Helvetica,Arial,sans-serif;min-height:100vh;display:grid;place-items:center;padding:24px}
    .app{width:min(860px,100%);background:rgba(17,24,39,.7);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.06);border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    header{padding:20px 24px;border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:10px}
    header h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.3px}
    header .badge{font-size:12px;color:#111827;background:var(--pri);padding:4px 8px;border-radius:999px;font-weight:700}
    main{display:grid;grid-template-columns:1.2fr .8fr;gap:16px;padding:20px}
    @media(max-width:820px){main{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row>label{min-width:120px;color:var(--muted)}
    input[type="text"]{flex:1;min-width:200px;background:#0b1220;border:1px solid rgba(255,255,255,.08);color:var(--text);padding:10px 12px;border-radius:12px;outline:none}
    button{appearance:none;border:0;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;color:#0b1220;background:var(--pri);transition:transform .02s ease,filter .15s ease}
    button:hover{filter:brightness(1.05)} button:active{transform:translateY(1px)}
    .btn-alt{background:#334155;color:#e5e7eb}
    .btn-warn{background:var(--warn)} .btn-danger{background:var(--danger)}
    .small{font-size:12px;color:var(--muted)}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.08);background:#0b1220;white-space:nowrap}
    .status{display:flex;align-items:center;gap:8px}
    .dot{width:8px;height:8px;border-radius:50%;background:#64748b}
    .dot.ok{background:#22c55e} .dot.warn{background:#f59e0b} .dot.err{background:#ef4444}
    audio{width:100%;margin-top:12px}
    pre{white-space:pre-wrap;word-wrap:break-word;background:#0b1220;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px;color:#d1d5db;max-height:220px;overflow:auto}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .muted{opacity:.7}
    .copy-btn{background:transparent;border:none;color:var(--pri2);cursor:pointer;font-size:16px}
    .toast{position:fixed;bottom:20px;right:20px;background:#22c55e;color:#fff;padding:8px 12px;border-radius:8px;opacity:0;transform:translateY(20px);transition:all .3s ease}
    .toast.show{opacity:1;transform:translateY(0)}
    .spinner{border:3px solid rgba(255,255,255,.1);border-top:3px solid var(--pri);border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .progress-bar{width:100%;height:6px;border-radius:6px;background:#334155;margin-top:6px;overflow:hidden}
    .progress-bar span{display:block;height:100%;background:var(--pri2);width:0%;transition:width .3s ease}
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<!-- Or for Google Material Icons: -->
<!-- <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet"> -->
</head>
<body>
  <div class="app">
    <header>
      <h1>Dolly Dialer</h1>
      <span class="badge">Audio • WebRTC</span>
    </header>
    <main>
      <section class="card" id="left">
        <div class="row">
          <label for="roomId">Room ID</label>
          <input id="roomId" type="text" placeholder="auto-generated on Create"/>
<button class="copy-btn" id="copyRoom"><i class="fas fa-copy"></i> Copy</button>
          <button id="createBtn">Create</button>
          <button id="joinBtn" class="btn-alt">Join</button>
        </div>
        <div class="row" style="margin-top:10px">
          <button id="hangupBtn" class="btn-danger" style="display:none">End Call</button>
          <button id="muteBtn" class="btn-alt" style="display:none">Mute</button>
          <button id="reconnectBtn" class="btn-warn" style="display:none">Reconnect</button>
          <span class="pill" id="netInfo">Net: —</span>
        </div>
        <div style="margin-top:12px" class="status">
          <div class="dot" id="statusDot"></div>
          <div id="statusText" class="small">Idle</div>
          <div id="spinner" class="spinner" style="display:none"></div>
        </div>
        <div class="progress-bar" id="progressWrap" style="display:none">
          <span id="progressFill"></span>
        </div>
        <audio id="remoteAudio" autoplay playsinline></audio>
        <audio id="localAudio" autoplay muted playsinline class="muted"></audio>
      </section>
      <section class="card" id="right">
        <div class="small" style="margin-bottom:8px">Debug</div>
        <pre id="log"></pre>
        <div class="grid2" style="margin-top:10px">
          <div>
            <div class="small">Local ICE</div>
            <pre id="iceLocal"></pre>
          </div>
          <div>
            <div class="small">Remote ICE</div>
            <pre id="iceRemote"></pre>
          </div>
        </div>
      </section>
    </main>
  </div>

  <div id="toast" class="toast">Copied!</div>

  <!-- Firebase + App logic -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot, collection, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAj-3oMIyfvpqUBJMoYa_IzwKXh5yR0G-A",
      authDomain: "getdet-6965b.firebaseapp.com",
      projectId: "getdet-6965b",
      storageBucket: "getdet-6965b.firebasestorage.app",
      messagingSenderId: "394828959439",
      appId: "1:394828959439:web:b3ca32fda12df2e2b731ba",
      measurementId: "G-CFMMWFEQGD"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const el = id => document.getElementById(id);
    const logBox = el('log'), statusDot = el('statusDot'), statusText = el('statusText');
    const netInfo = el('netInfo');

    function log(...args){
      const line = args.map(a => typeof a === 'object' ? JSON.stringify(a,null,2) : String(a)).join(' ');
      logBox.textContent = (line + '\n') + logBox.textContent;
      console.log(...args);
    }

    function setStatus(txt, type=''){
      statusText.textContent = txt;
      statusDot.className = 'dot ' + (type||'');
      if (txt.includes("Creating") || txt.includes("Joining") || txt.includes("Connecting")){
        el("spinner").style.display = "inline-block";
      } else {
        el("spinner").style.display = "none";
      }
    }

    function toggleUI(state){
      if(state==="idle"){
        el("createBtn").style.display = "";
        el("joinBtn").style.display = "";
        el("hangupBtn").style.display = "none";
        el("muteBtn").style.display = "none";
        el("reconnectBtn").style.display = "none";
      }
      if(state==="calling"){
        el("createBtn").style.display = "none";
        el("joinBtn").style.display = "none";
        el("hangupBtn").style.display = "";
        el("muteBtn").style.display = "";
      }
      if(state==="failed"){
        el("reconnectBtn").style.display = "";
      } else {
        el("reconnectBtn").style.display = "none";
      }
    }

    let pc, localStream, remoteStream, roomRef, unsubRoom, role=null, isMuted=false;
    const rtcConfig={iceServers:[{urls:['stun:stun.l.google.com:19302','stun:stun1.l.google.com:19302']}],iceCandidatePoolSize:8};

    function getConstraints(){ return {audio:{echoCancellation:true,noiseSuppression:true,autoGainControl:true},video:false}; }

    async function prepareMedia(){
      localStream = await navigator.mediaDevices.getUserMedia(getConstraints());
      el('localAudio').srcObject = localStream;
    }

    function setupPC(){
      pc = new RTCPeerConnection(rtcConfig);
      localStream.getTracks().forEach(t=>pc.addTrack(t,localStream));
      const sender=pc.getSenders().find(s=>s.track && s.track.kind==="audio");
      if(sender){const params=sender.getParameters();params.encodings=[{maxBitrate:20000}];sender.setParameters(params).catch(()=>{});}
      remoteStream=new MediaStream();
      pc.ontrack=(e)=>{e.streams[0].getAudioTracks().forEach(track=>remoteStream.addTrack(track));el('remoteAudio').srcObject=remoteStream;setStatus('Connected','ok');toggleUI("calling");};
      pc.onicecandidate=async(event)=>{if(!event.candidate)return;log('Local ICE:',event.candidate.candidate);el('iceLocal').textContent+=event.candidate.candidate+"\n";if(!roomRef)return;const coll=collection(roomRef, role==='caller'?'callerCandidates':'calleeCandidates');await addDoc(coll,event.candidate.toJSON());};
      pc.onconnectionstatechange=()=>{log('State:',pc.connectionState);if(pc.connectionState==="connected"){setStatus('Connected','ok');toggleUI("calling");}else if(pc.connectionState==="connecting"){setStatus('Connecting','warn');}else if(pc.connectionState==="failed"){setStatus('Reconnecting / Failed','err');toggleUI("failed");}else if(pc.connectionState==="disconnected"){setStatus('Disconnected','err');toggleUI("failed");}};
      updateNetInfo();
    }

    function startProgress(){
      let progress=0;el("progressWrap").style.display="block";el("progressFill").style.width="0%";
      const interval=setInterval(()=>{progress+=10;el("progressFill").style.width=progress+"%";if(progress>=100)clearInterval(interval);},400);
    }

    async function createRoom(){
      role='caller';setStatus('Creating room…','warn');toggleUI("idle");roomRef=doc(collection(db,'rooms'));
      await prepareMedia();setupPC();
      const offer=await pc.createOffer({offerToReceiveAudio:true});await pc.setLocalDescription(offer);
      await setDoc(roomRef,{offer:{sdp:offer.sdp,type:offer.type},created:Date.now()});
      unsubRoom=onSnapshot(roomRef,async snap=>{const data=snap.data();if(!pc.currentRemoteDescription && data?.answer){await pc.setRemoteDescription(new RTCSessionDescription(data.answer));log('Answer set');}});
      onSnapshot(collection(roomRef,'calleeCandidates'),async snap=>{for(const change of snap.docChanges()){if(change.type==='added'){const candidate=new RTCIceCandidate(change.doc.data());el('iceRemote').textContent+=(candidate.candidate||'')+"\n";await pc.addIceCandidate(candidate).catch(()=>{});}}});
      el('roomId').value=roomRef.id;setStatus('Room created. Share Room ID with partner.','warn');startProgress();
    }

    async function joinRoom(){
      const id=el('roomId').value.trim();if(!id)return alert('Enter Room ID to join');role='callee';setStatus('Joining…','warn');toggleUI("idle");
      roomRef=doc(db,'rooms',id);const snap=await getDoc(roomRef);if(!snap.exists())return alert('Room not found');const data=snap.data();
      await prepareMedia();setupPC();
      await pc.setRemoteDescription(new RTCSessionDescription(data.offer));const answer=await pc.createAnswer();await pc.setLocalDescription(answer);
      await updateDoc(roomRef,{answer:{type:answer.type,sdp:answer.sdp},answered:Date.now()});
      onSnapshot(collection(roomRef,'callerCandidates'),async snap=>{for(const change of snap.docChanges()){if(change.type==='added'){const candidate=new RTCIceCandidate(change.doc.data());el('iceRemote').textContent+=(candidate.candidate||'')+"\n";await pc.addIceCandidate(candidate).catch(()=>{});}}});
      setStatus('Connected (answer sent)','ok');toggleUI("calling");startProgress();
    }

    async function hangup(){
      try{unsubRoom && unsubRoom();}catch(_){}
      if(pc){pc.getSenders().forEach(s=>{try{s.track?.stop()}catch{}});pc.close();}
      pc=null;role=null;roomRef=null;localStream?.getTracks().forEach(t=>t.stop());
      el('remoteAudio').srcObject=null;el('localAudio').srcObject=null;setStatus('Idle');toggleUI("idle");
    }

    async function reconnect(){if(!pc)return;try{await pc.restartIce();setStatus('Restarting ICE…','warn');}catch(e){log('ICE restart failed',e);}}

    function toggleMute(){isMuted=!isMuted;localStream?.getAudioTracks().forEach(t=>t.enabled=!isMuted);el('muteBtn').textContent=isMuted?'Unmute':'Mute';}

    function updateNetInfo(){if(navigator.connection){const c=navigator.connection;netInfo.textContent='Net: '+`${c.effectiveType||'—'} · downlink ${c.downlink||'—'}Mb · rtt ${c.rtt||'—'}ms`;}else{netInfo.textContent='Net: n/a';}}

    el('createBtn').onclick=createRoom;
    el('joinBtn').onclick=joinRoom;
    el('hangupBtn').onclick=hangup;
    el('muteBtn').onclick=toggleMute;
    el('reconnectBtn').onclick=reconnect;

    el('copyRoom').onclick=()=>{const id=el('roomId').value;if(!id)return;navigator.clipboard.writeText(id).then(()=>{el('toast').classList.add('show');setTimeout(()=>el('toast').classList.remove('show'),2000);});};

    if(navigator.connection){['change','typechange'].forEach(ev=>navigator.connection.addEventListener(ev,updateNetInfo));}
    window.addEventListener('beforeunload',(e)=>{if(pc){e.preventDefault();e.returnValue='';}});
  </script>
</body>
</html>
